<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alfie's Workout Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styling for the app */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom theme colors (Material 3 inspired) */
        :root {
            --bg-primary: #1a202c; /* Dark Blue-Grey */
            --bg-secondary: #2d3748; /* Slightly Lighter Blue-Grey */
            --bg-secondary-light: #4a5568; /* Lighter Blue-Grey */
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --accent-blue: #4A90E2; /* Pastel Blue */
            --accent-blue-dark: #3A7BC8;
            --accent-green: #34D399; /* For 'complete' state */
            --accent-green-dark: #065F46; /* Background for 'complete' */
        }

        /* Dark mode theme */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-secondary-light);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* JS-based animation style for quotes */
        .quote-list {
            transition: transform 0.5s ease-in-out;
        }

    </style>
</head>
<body class="pb-24">

    <!-- Main App Container -->
    <div id="app" class="h-full">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <!-- Bottom Navigation Bar -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-16 bg-[var(--bg-secondary)] border-t border-[var(--bg-secondary-light)] flex justify-around items-center z-50">
        <!-- Nav items will be rendered here by JavaScript -->
    </nav>

    <!-- Floating Timer Button (hidden by default) -->
    <button id="floating-timer-btn" class="hidden fixed bottom-20 right-4 bg-[var(--accent-blue)] text-white p-3 rounded-full shadow-lg z-40" onclick="appState.toggleTimerModal(true)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
    </button>

    <!-- Timer Modal (hidden by default) -->
    <div id="timer-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white text-gray-900 p-6 rounded-lg shadow-2xl w-full max-w-sm border border-[var(--bg-secondary-light)]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Rest Timer</h3>
                <button onclick="appState.toggleTimerModal(false)" class="text-gray-500 hover:text-gray-900">
                    <!-- Minimize Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19v-6M12 13l-4 4M12 13l4 4"/></svg>
                </button>
            </div>
            <div class="text-6xl font-mono text-center mb-6" id="timer-display">2:00</div>
            <div class="flex justify-center space-x-4 mb-4">
                <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full" onclick="appState.timer.set(60)">1:00</button>
                <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full" onclick="appState.timer.set(90)">1:30</button>
                <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full" onclick="appState.timer.set(120)">2:00</button>
                <button class="bg-gray-200 text-gray-700 px-3 py-1 rounded-full" onclick="appState.timer.set(180)">3:00</button>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="timer-start-pause" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold w-1/2" onclick="appState.timer.startPause()">Start</button>
                <button class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg w-1/2" onclick="appState.timer.reset()">Reset</button>
            </div>
        </div>
    </div>

    <!-- Countdown Beep Modal (hidden by default) -->
    <div id="countdown-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="text-white text-9xl font-bold" id="countdown-display"></div>
    </div>
    
    <!-- Generic Modal for AI Tips, Errors, etc. -->
    <div id="generic-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-[var(--bg-secondary)] p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold"></h3>
                <button onclick="appState.hideModal()" class="text-[var(--text-secondary)]">&times;</button>
            </div>
            <div id="modal-content" class="text-[var(--text-primary)] whitespace-pre-wrap"></div>
            <div id="modal-footer" class="mt-6 flex justify-end">
                <button onclick="appState.hideModal()" class="bg-[var(--accent-blue)] text-white px-4 py-2 rounded-lg">Close</button>
            </div>
        </div>
    </div>


    <!-- Main Application Logic -->
    <script>
        // Store app element
        const app = document.getElementById('app');
        const bottomNav = document.getElementById('bottom-nav');

        // --- ALL APP STATE & LOGIC ---
        const appState = {
            currentPage: 'home',
            history: [], // Array of completed workout objects
            measurements: [], // Array of { date, weight, arm, chest, leg }
            workoutProgram: {}, // The 12-week program
            activeWorkout: null, // { week, day, dayKey, exercises: [...] }
            
            // --- Gemini API ---
            geminiApiKey: "", // User must provide this
            geminiApiCallCount: 0,
            geminiMaxRetries: 3,
            
            // --- Gym Quotes ---
            gymQuotes: [
                "The only bad workout is the one that didn't happen.",
                "Strive for progress, not perfection.",
                "The hard part isn't getting your body in shape. The hard part is getting your mind in shape.",
                "Discipline is the bridge between goals and accomplishment.",
                "You don't have to be extreme, just consistent.",
                "Sweat is fat crying.",
                "The pain you feel today will be the strength you feel tomorrow.",
                "Obsessed is just a word the lazy use to describe the dedicated.",
                "Don't limit your challenges. Challenge your limits.",
                "Get after it!",
                "It's a slow process, but quitting won't speed it up.",
                "Sore today, strong tomorrow.",
                "No pain, no gain.",
                "If it doesn't challenge you, it doesn't change you.",
                "Train insane or remain the same.",
                "The last three or four reps is what makes the muscle grow.",
                "Hustle for that muscle.",
                "Light weight, baby!",
                "Everybody wants to be a bodybuilder, but nobody wants to lift no heavy-ass weights.",
                "One more rep.",
                "You are what you eat, so don't be fast, cheap, easy, or fake.",
                "Eat clean, train dirty.",
                "Abs are made in the kitchen.",
                "Don't be afraid of being a beginner.",
                "Consistency is key.",
                "Success starts with self-discipline.",
                "The gym is my therapy.",
                "Be stronger than your excuses.",
                "Motivation is what gets you started. Habit is what keeps you going.",
                "Wake up with determination. Go to bed with satisfaction."
            ],
            currentQuoteIndex: 0,
            quoteInterval: null,

            // --- Initial 12-Week Program Data ---
            // This is the source of truth, loaded into local storage
            INITIAL_WORKOUT_PROGRAM: {
                weeks1_4: {
                    name: "Hypertrophy - Foundation (Weeks 1-4)",
                    day1: { name: "Chest & Triceps", exercises: [
                        { name: "Bench Press (Barbell or Dumbbell)", sets: 4, reps: "12-15" },
                        { name: "Incline Dumbbell Press", sets: 4, reps: "12-15" },
                        { name: "Chest Flyes (Dumbbell or Cable)", sets: 3, reps: "15-20" },
                        { name: "Tricep Dips (Assisted or Bodyweight)", sets: 3, reps: "10-15" },
                        { name: "Tricep Pushdowns (Rope or Bar)", sets: 4, reps: "12-15" },
                        { name: "Overhead Tricep Extension", sets: 3, reps: "12-15" },
                    ]},
                    day2: { name: "Back & Biceps", exercises: [
                        { name: "Pull-Ups (Assisted or Lat Pulldown)", sets: 4, reps: "10-12" },
                        { name: "Bent-Over Rows (Barbell or Dumbbell)", sets: 4, reps: "12-15" },
                        { name: "Seated Cable Row", sets: 3, reps: "12-15" },
                        { name: "Face Pulls", sets: 3, reps: "15-20" },
                        { name: "Bicep Curls (Dumbbell or Barbell)", sets: 4, reps: "12-15" },
                        { name: "Hammer Curls", sets: 3, reps: "12-15" },
                    ]},
                    day3: { name: "Legs", exercises: [
                        { name: "Squats (Barbell or Goblet)", sets: 4, reps: "12-15" },
                        { name: "Romanian Deadlifts (RDL)", sets: 4, reps: "12-15" },
                        { name: "Leg Press", sets: 3, reps: "15-20" },
                        { name: "Leg Extensions", sets: 3, reps: "15-20" },
                        { name: "Leg Curls", sets: 3, reps: "15-20" },
                        { name: "Calf Raises", sets: 4, reps: "15-20" },
                    ]},
                    day4: { name: "Shoulders", exercises: [
                        { name: "Overhead Press (Dumbbell or Barbell)", sets: 4, reps: "12-15" },
                        { name: "Lateral Raises", sets: 4, reps: "15-20" },
                        { name: "Front Raises (Dumbbell or Plate)", sets: 3, reps: "15-20" },
                        { name: "Reverse Pec Deck (Rear Delts)", sets: 3, reps: "15-20" },
                        { name: "Shrugs (Dumbbell or Barbell)", sets: 3, reps: "12-15" },
                    ]},
                    day5: { name: "Core & Mobility", exercises: [
                        { name: "Crunches", sets: 3, reps: "15-20" },
                        { name: "Lying Leg Raises", sets: 3, reps: "15-20" },
                        { name: "Plank", sets: 3, reps: "60s" },
                        { name: "Side Planks", sets: 3, reps: "45s per side" },
                        { name: "Bird-Dog", sets: 3, reps: "10 per side" }
                    ]}
                },
                weeks5_8: {
                    name: "Hypertrophy - Intensification (Weeks 5-8)",
                    day1: { name: "Chest & Triceps", exercises: [
                        { name: "Bench Press (Barbell or Dumbbell)", sets: 4, reps: "8-10" },
                        { name: "Incline Dumbbell Press", sets: 4, reps: "8-10" },
                        { name: "Chest Flyes (Dumbbell or Cable)", sets: 3, reps: "10-12" },
                        { name: "Close Grip Bench Press", sets: 3, reps: "8-10" },
                        { name: "Tricep Pushdowns (Rope or Bar)", sets: 4, reps: "10-12" },
                        { name: "Overhead Tricep Extension", sets: 3, reps: "10-12" },
                    ]},
                    day2: { name: "Back & Biceps", exercises: [
                        { name: "Pull-Ups (Assisted or Lat Pulldown)", sets: 4, reps: "8-10" },
                        { name: "Bent-Over Rows (Barbell or Dumbbell)", sets: 4, reps: "8-10" },
                        { name: "Seated Cable Row", sets: 3, reps: "10-12" },
                        { name: "Face Pulls", sets: 3, reps: "12-15" },
                        { name: "Bicep Curls (Dumbbell or Barbell)", sets: 4, reps: "8-10" },
                        { name: "Hammer Curls", sets: 3, reps: "10-12" },
                    ]},
                    day3: { name: "Legs", exercises: [
                        { name: "Squats (Barbell or Goblet)", sets: 4, reps: "8-10" },
                        { name: "Romanian Deadlifts (RDL)", sets: 4, reps: "8-10" },
                        { name: "Leg Press", sets: 3, reps: "10-12" },
                        { name: "Leg Extensions", sets: 3, reps: "12-15" },
                        { name: "Leg Curls", sets: 3, reps: "12-15" },
                        { name: "Calf Raises", sets: 4, reps: "10-12" },
                    ]},
                    day4: { name: "Shoulders", exercises: [
                        { name: "Overhead Press (Dumbbell or Barbell)", sets: 4, reps: "8-10" },
                        { name: "Lateral Raises", sets: 4, reps: "12-15" },
                        { name: "Front Raises (Dumbbell or Plate)", sets: 3, reps: "12-15" },
                        { name: "Reverse Pec Deck (Rear Delts)", sets: 3, reps: "12-15" },
                        { name: "Shrugs (Dumbbell or Barbell)", sets: 3, reps: "10-12" },
                    ]},
                    day5: { name: "Core & Mobility", exercises: [
                        { name: "Cable Crunches", sets: 3, reps: "12-15" },
                        { name: "Hanging Leg Raises", sets: 3, reps: "12-15" },
                        { name: "Plank", sets: 3, reps: "90s" },
                        { name: "Side Planks", sets: 3, reps: "60s per side" },
                        { name: "Russian Twists", sets: 3, reps: "15 per side" }
                    ]}
                },
                weeks9_12: {
                    name: "Hypertrophy - Peak (Weeks 9-12)",
                    day1: { name: "Chest & Triceps", exercises: [
                        { name: "Bench Press (Barbell or Dumbbell)", sets: 4, reps: "6-8" },
                        { name: "Incline Dumbbell Press", sets: 4, reps: "6-8" },
                        { name: "Dips (Weighted or Bodyweight)", sets: 3, reps: "6-8" },
                        { name: "Close Grip Bench Press", sets: 3, reps: "6-8" },
                        { name: "Tricep Pushdowns (V-Bar)", sets: 4, reps: "8-10" },
                        { name: "Single Arm Overhead Extension", sets: 3, reps: "8-10" },
                    ]},
                    day2: { name: "Back & Biceps", exercises: [
                        { name: "Weighted Pull-Ups (or Lat Pulldown)", sets: 4, reps: "6-8" },
                        { name: "Pendlay Rows", sets: 4, reps: "6-8" },
                        { name: "T-Bar Row", sets: 3, reps: "8-10" },
                        { name: "Face Pulls", sets: 3, reps: "10-12" },
                        { name: "Barbell Curls", sets: 4, reps: "6-8" },
                        { name: "Incline Dumbbell Curls", sets: 3, reps: "8-10" },
                    ]},
                    day3: { name: "Legs", exercises: [
                        { name: "Squats (Barbell)", sets: 4, reps: "6-8" },
                        { name: "Deadlifts (Conventional or Sumo)", sets: 1, reps: "5" }, // Heavy 1x5
                        { name: "Romanian Deadlifts (RDL)", sets: 3, reps: "8-10" },
                        { name: "Leg Press", sets: 3, reps: "8-10" },
                        { name: "Hack Squat", sets: 3, reps: "8-10" },
                        { name: "Calf Raises (Seated & Standing)", sets: 4, reps: "8-10" },
                    ]},
                    day4: { name: "Shoulders", exercises: [
                        { name: "Overhead Press (Barbell)", sets: 4, reps: "6-8" },
                        { name: "Lateral Raises (Heavy)", sets: 4, reps: "10-12" },
                        { name: "Front Raises (Dumbbell or Plate)", sets: 3, reps: "10-12" },
                        { name: "Reverse Pec Deck (Rear Delts)", sets: 3, reps: "10-12" },
                        { name: "Shrugs (Dumbbell or Barbell)", sets: 3, reps: "8-10" },
                    ]},
                    day5: { name: "Core & Mobility", exercises: [
                        { name: "Weighted Crunches", sets: 3, reps: "10-12" },
                        { name: "Hanging Leg Raises (Weighted)", sets: 3, reps: "10-12" },
                        { name: "Weighted Plank", sets: 3, reps: "90s" },
                        { name: "Side Planks (Weighted)", sets: 3, reps: "60s per side" },
                        { name: "Ab Rollout", sets: 3, reps: "10-12" }
                    ]}
                }
            },

            // --- Local Storage ---
            saveState() {
                localStorage.setItem('alfie_history', JSON.stringify(this.history));
                localStorage.setItem('alfie_measurements', JSON.stringify(this.measurements));
                localStorage.setItem('alfie_workout_program', JSON.stringify(this.workoutProgram));
                localStorage.setItem('alfie_active_workout', JSON.stringify(this.activeWorkout));
                localStorage.setItem('alfie_gemini_key', this.geminiApiKey);
            },

            loadState() {
                const history = localStorage.getItem('alfie_history');
                const measurements = localStorage.getItem('alfie_measurements');
                const program = localStorage.getItem('alfie_workout_program');
                const activeWorkout = localStorage.getItem('alfie_active_workout');
                const geminiKey = localStorage.getItem('alfie_gemini_key');

                this.history = history ? JSON.parse(history) : [];
                this.measurements = measurements ? JSON.parse(measurements) : [];
                this.workoutProgram = program ? JSON.parse(program) : this.INITIAL_WORKOUT_PROGRAM;
                this.activeWorkout = activeWorkout ? JSON.parse(activeWorkout) : null;
                this.geminiApiKey = geminiKey ? geminiKey : "";
                
                // If no program, load initial and save
                if (!program) {
                    this.saveState();
                }
            },

            // --- Navigation ---
            navigateTo(page) {
                this.currentPage = page;
                this.renderApp();
            },

            // --- App Rendering ---
            renderApp() {
                // Show/hide floating timer
                const timerBtn = document.getElementById('floating-timer-btn');
                if (this.currentPage === 'workout' && !this.timer.modalOpen) {
                    timerBtn.classList.remove('hidden');
                } else {
                    timerBtn.classList.add('hidden');
                }

                // Render main page content
                switch (this.currentPage) {
                    case 'home':
                        this.renderHomePage();
                        break;
                    case 'workouts':
                        this.renderWorkoutsPage();
                        break;
                    case 'progress':
                        this.renderProgressPage();
                        break;
                    case 'coach':
                        this.renderCoachPage();
                        break;
                    case 'workout':
                        this.renderWorkoutInProgressPage();
                        break;
                }
                
                // Render nav bar
                this.renderBottomNav();
            },

            // --- Bottom Nav ---
            renderBottomNav() {
                const navItems = [
                    { name: 'Home', icon: this.icons.home, page: 'home' },
                    { name: 'Workouts', icon: this.icons.dumbbell, page: 'workouts' },
                    { name: 'Progress', icon: this.icons.progress, page: 'progress' },
                    { name: 'Coach', icon: this.icons.coach, page: 'coach' },
                ];

                bottomNav.innerHTML = navItems.map(item => {
                    const isActive = this.currentPage === item.page;
                    return `
                        <button 
                            class="flex flex-col items-center justify-center w-full h-full ${isActive ? 'text-[var(--accent-blue)]' : 'text-[var(--text-secondary)]'}"
                            onclick="appState.navigateTo('${item.page}')"
                        >
                            ${item.icon}
                            <span class="text-xs mt-1">${item.name}</span>
                        </button>
                    `;
                }).join('');
            },

            // --- Home Page ---
            renderHomePage() {
                const quoteCard = this.renderQuoteCard();
                const nextWorkoutCard = this.renderNextWorkoutCard();
                const funMetrics = this.renderFunMetrics();

                app.innerHTML = `
                    <div class="p-4 max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-4">Hi Alfie,</h1>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            ${quoteCard}
                            ${nextWorkoutCard}
                        </div>
                        
                        ${this.renderWorkoutPicker()}
                        ${funMetrics}
                    </div>
                `;
                
                // Start the quote scroller
                this.startQuoteScroller();
            },
            
            startQuoteScroller() {
                const quoteListEl = document.getElementById('quote-list');
                if (!quoteListEl) return;

                if (this.quoteInterval) {
                    clearInterval(this.quoteInterval);
                }
                
                this.currentQuoteIndex = 0;
                
                this.quoteInterval = setInterval(() => {
                    this.currentQuoteIndex = (this.currentQuoteIndex + 1) % this.gymQuotes.length;
                    const newTransform = `translateY(-${this.currentQuoteIndex * (100 / this.gymQuotes.length)}%)`;
                    quoteListEl.style.transform = newTransform;
                    
                    // Reset to start when it hits the end
                    if (this.currentQuoteIndex === this.gymQuotes.length - 1) {
                        setTimeout(() => {
                            quoteListEl.style.transition = 'none'; // Jump back without animation
                            quoteListEl.style.transform = 'translateY(0)';
                            this.currentQuoteIndex = 0;
                            
                            // Force reflow
                            void quoteListEl.offsetWidth; 
                            
                            // Re-enable transition
                            quoteListEl.style.transition = 'transform 0.5s ease-in-out';
                        }, 1000); // Wait 1s at the end
                    }
                }, 3000); // Change quote every 3 seconds
            },

            renderQuoteCard() {
                return `
                    <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg h-64 overflow-hidden relative">
                        <div class="absolute inset-0 overflow-hidden">
                            <div id="quote-list" class="quote-list">
                                ${this.gymQuotes.map(quote => `
                                    <div class="h-64 flex items-center justify-center p-4">
                                        <p class="text-lg text-center italic text-[var(--text-primary)]">"${quote}"</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderFunMetrics() {
                const totals = this.calculateTotals();
                
                const formatNumber = (num) => {
                    if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + 'm';
                    if (num >= 1_000) return (num / 1_000).toFixed(1) + 'k';
                    return num;
                };

                return `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg text-center">
                            <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Total Sessions</h3>
                            <p class="text-3xl font-bold">${totals.sessions}</p>
                        </div>
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg text-center">
                            <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Total Volume (kg)</h3>
                            <p class="text-3xl font-bold">${formatNumber(totals.volume)}</p>
                        </div>
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg text-center">
                            <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Total Reps</h3>
                            <p class="text-3xl font-bold">${formatNumber(totals.reps)}</p>
                        </div>
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg text-center">
                            <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Total Sets</h3>
                            <p class="text-3xl font-bold">${formatNumber(totals.sets)}</p>
                        </div>
                    </div>
                `;
            },
            
            calculateTotals() {
                return this.history.reduce((acc, session) => {
                    acc.sessions += 1;
                    session.exercises.forEach(ex => {
                        ex.sets.forEach(set => {
                            acc.sets += 1;
                            acc.reps += set.reps || 0;
                            acc.volume += (set.weight || 0) * (set.reps || 0);
                        });
                    });
                    return acc;
                }, { sessions: 0, volume: 0, reps: 0, sets: 0 });
            },

            getNextWorkout() {
                if (this.history.length === 0) {
                    return { week: 1, dayKey: 'day1', program: this.workoutProgram.weeks1_4 };
                }

                const lastWorkout = this.history[this.history.length - 1];
                let lastWeek = lastWorkout.week;
                let lastDayKey = lastWorkout.dayKey;

                let nextWeek = lastWeek;
                let nextDayKey;

                const dayKeys = ['day1', 'day2', 'day3', 'day4', 'day5'];
                const lastDayIndex = dayKeys.indexOf(lastDayKey);

                if (lastDayIndex === 4) { // Was last day
                    nextDayKey = 'day1';
                    nextWeek = lastWeek + 1;
                } else {
                    nextDayKey = dayKeys[lastDayIndex + 1];
                }

                if (nextWeek > 12) { // Completed program
                    return { week: 1, dayKey: 'day1', program: this.workoutProgram.weeks1_4 };
                }

                let program;
                if (nextWeek <= 4) program = this.workoutProgram.weeks1_4;
                else if (nextWeek <= 8) program = this.workoutProgram.weeks5_8;
                else program = this.workoutProgram.weeks9_12;

                return { week: nextWeek, dayKey: nextDayKey, program };
            },

            renderNextWorkoutCard() {
                // Check for active workout first
                if (this.activeWorkout) {
                    const workout = this.activeWorkout;
                    return `
                        <div class="bg-[var(--bg-secondary)] rounded-lg shadow-lg h-64 flex flex-col justify-between p-6 relative border-2 border-[var(--accent-green)]">
                            <div class="absolute top-2 right-2 bg-[var(--accent-green)] text-white text-xs font-bold px-2 py-1 rounded">In Progress</div>
                            <div>
                                <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Resume Workout</h3>
                                <h2 class="text-2xl font-bold mt-1">${workout.day.name}</h2>
                                <p class="text-lg text-[var(--text-secondary)]">Week ${workout.week}</p>
                            </div>
                            <button class="absolute right-6 bottom-6 bg-[var(--accent-green)] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl" onclick="appState.resumeWorkout()">
                                ${this.icons.play}
                            </button>
                        </div>
                    `;
                }

                const next = this.getNextWorkout();
                const workout = next.program[next.dayKey];

                return `
                    <div class="bg-[var(--bg-secondary)] rounded-lg shadow-lg h-64 flex flex-col justify-between p-6 relative">
                        <div>
                            <h3 class="text-sm font-semibold text-[var(--text-secondary)]">Next Workout</h3>
                            <h2 class="text-2xl font-bold mt-1">${workout.name}</h2>
                            <p class="text-lg text-[var(--text-secondary)]">Week ${next.week}</p>
                        </div>
                        <button class="absolute right-6 bottom-6 bg-[var(--accent-blue)] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-xl" onclick="appState.startNextWorkout()">
                            ${this.icons.play}
                        </button>
                    </div>
                `;
            },
            
            renderWorkoutPicker() {
                const isDisabled = this.activeWorkout ? 'opacity-50 pointer-events-none' : '';
                
                return `
                    <div class="mt-8 ${isDisabled}">
                        <h3 class="text-xl font-semibold mb-3">Or, select a workout</h3>
                        ${Object.keys(this.workoutProgram).map(weekKey => {
                            const weekNum = weekKey.split('_')[0].replace('weeks', '');
                            const program = this.workoutProgram[weekKey];
                            return `
                                <details class="mb-2">
                                    <summary class="bg-[var(--bg-secondary)] p-4 rounded-lg cursor-pointer font-semibold">${program.name}</summary>
                                    <div class="bg-[var(--bg-secondary-light)] p-4 rounded-b-lg">
                                        ${['day1', 'day2', 'day3', 'day4', 'day5'].map(dayKey => {
                                            const day = program[dayKey];
                                            return `
                                                <button class="block w-full text-left p-2 hover:bg-[var(--bg-primary)] rounded" onclick="appState.startSpecificWorkout('${weekNum}', '${dayKey}')">
                                                    ${day.name}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            // --- Workouts Page ---
            renderWorkoutsPage() {
                app.innerHTML = `
                    <div class="p-4 max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-6">Workout Program</h1>
                        ${Object.keys(this.workoutProgram).map(weekKey => {
                            const program = this.workoutProgram[weekKey];
                            return `
                                <details class="mb-4" ${weekKey === 'weeks1_4' ? 'open' : ''}>
                                    <summary class="bg-[var(--bg-secondary)] p-4 rounded-lg cursor-pointer text-xl font-semibold">${program.name}</summary>
                                    <div class="bg-[var(--bg-secondary-light)] p-2 rounded-b-lg">
                                        ${['day1', 'day2', 'day3', 'day4', 'day5'].map(dayKey => {
                                            const day = program[dayKey];
                                            return `
                                                <details class="mb-2">
                                                    <summary class="p-3 font-semibold text-lg">${day.name}</summary>
                                                    <ul class="pl-6 pb-2">
                                                        ${day.exercises.map((ex, exIndex) => `
                                                            <li class="flex justify-between items-center p-2">
                                                                <div>
                                                                    <span>${ex.name}</span>
                                                                    <span class="text-sm text-[var(--text-secondary)] ml-2">${ex.sets} sets x ${ex.reps}</span>
                                                                </div>
                                                                <div class="flex items-center">
                                                                    <button class="text-[var(--accent-blue)] mr-4" onclick="appState.getFormTips('${ex.name}')">
                                                                        ${this.icons.sparkle}
                                                                    </button>
                                                                    <button class="text-red-500" onclick="appState.deleteExercise('${weekKey}', '${dayKey}', ${exIndex})">
                                                                        ${this.icons["delete"]}
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        `).join('')}
                                                    </ul>
                                                </details>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            deleteExercise(weekKey, dayKey, exerciseIndex) {
                if (confirm('Are you sure you want to delete this exercise? This change is permanent.')) {
                    this.workoutProgram[weekKey][dayKey].exercises.splice(exerciseIndex, 1);
                    this.saveState();
                    this.renderApp();
                }
            },

            // --- Progress Page ---
            renderProgressPage() {
                app.innerHTML = `
                    <div class="p-4 max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-6">Track Progress</h1>
                        
                        <!-- Add Measurement -->
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg mb-6">
                            <h3 class="text-xl font-semibold mb-4">Log Today's Measurements</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-[var(--text-secondary)] mb-1">Weight (kg)</label>
                                    <input id="measure-weight" type="number" step="0.1" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" placeholder="70.5">
                                </div>
                                <div>
                                    <label class="block text-sm text-[var(--text-secondary)] mb-1">Arm (cm)</label>
                                    <input id="measure-arm" type="number" step="0.1" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" placeholder="35">
                                </div>
                                <div>
                                    <label class="block text-sm text-[var(--text-secondary)] mb-1">Chest (cm)</label>
                                    <input id="measure-chest" type="number" step="0.1" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" placeholder="100">
                                </div>
                                <div>
                                    <label class="block text-sm text-[var(--text-secondary)] mb-1">Leg (cm)</label>
                                    <input id="measure-leg" type="number" step="0.1" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" placeholder="55">
                                </div>
                            </div>
                            <button class="w-full bg-[var(--accent-blue)] text-white p-3 rounded-lg mt-4 font-semibold" onclick="appState.saveMeasurement()">
                                Save Measurements
                            </button>
                        </div>
                        
                        <!-- History -->
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg mb-6">
                            <h3 class="text-xl font-semibold mb-4">Measurement History</h3>
                            <div class="max-h-60 overflow-y-auto">
                                ${this.measurements.length === 0 ? '<p class="text-[var(--text-secondary)]">No measurements logged yet.</p>' : ''}
                                ${[...this.measurements].reverse().map(m => `
                                    <div class="border-b border-[var(--bg-secondary-light)] p-2">
                                        <p class="font-semibold">${new Date(m.date).toLocaleDateString()}</p>
                                        <p class="text-sm text-[var(--text-secondary)]">
                                            ${m.weight ? `Weight: ${m.weight}kg` : ''}
                                            ${m.arm ? ` • Arm: ${m.arm}cm` : ''}
                                            ${m.chest ? ` • Chest: ${m.chest}cm` : ''}
                                            ${m.leg ? ` • Leg: ${m.leg}cm` : ''}
                                        </p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Lift Progress -->
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg">
                            <h3 class="text-xl font-semibold mb-4">Lift Progress (1-Rep Max)</h3>
                            ${this.renderAllLiftProgressGraphs()}
                        </div>
                    </div>
                `;
            },
            
            saveMeasurement() {
                const weight = document.getElementById('measure-weight').value;
                const arm = document.getElementById('measure-arm').value;
                const chest = document.getElementById('measure-chest').value;
                const leg = document.getElementById('measure-leg').value;
                
                if (!weight && !arm && !chest && !leg) {
                    alert('Please enter at least one measurement.');
                    return;
                }
                
                this.measurements.push({
                    date: new Date().toISOString(),
                    weight: parseFloat(weight) || null,
                    arm: parseFloat(arm) || null,
                    chest: parseFloat(chest) || null,
                    leg: parseFloat(leg) || null,
                });
                
                this.saveState();
                this.renderApp();
            },
            
            getLiftHistory() {
                // Creates an object: { 'Bench Press': [ {date, 1rm}, ... ], ... }
                const liftHistory = {};
                this.history.forEach(session => {
                    session.exercises.forEach(ex => {
                        const max1rm = ex.sets.reduce((max, set) => {
                            const current1rm = this.calculate1RME(set.weight, set.reps);
                            return current1rm > max ? current1rm : max;
                        }, 0);
                        
                        if (max1rm > 0) {
                            if (!liftHistory[ex.name]) {
                                liftHistory[ex.name] = [];
                            }
                            liftHistory[ex.name].push({ date: session.date, '1rm': max1rm });
                        }
                    });
                });
                return liftHistory;
            },
            
            renderAllLiftProgressGraphs() {
                const liftHistory = this.getLiftHistory();
                const liftNames = Object.keys(liftHistory);
                
                if (liftNames.length === 0) {
                    return '<p class="text-[var(--text-secondary)]">Log some workouts to see your lift progress!</p>';
                }
                
                return liftNames.map(liftName => {
                    const data = liftHistory[liftName];
                    if (data.length < 2) {
                        return ''; // Don't show graph for less than 2 data points
                    }
                    
                    const max1rm = Math.max(...data.map(d => d['1rm']));
                    const min1rm = Math.min(...data.map(d => d['1rm']));
                    
                    // Simple SVG sparkline
                    const points = data.map((d, i) => {
                        const x = (i / (data.length - 1)) * 100;
                        const y = 100 - ((d['1rm'] - min1rm) / (max1rm - min1rm + 0.001)) * 100; // +0.001 to avoid div by zero
                        return `${x},${y}`;
                    }).join(' ');

                    return `
                        <div class="mb-4">
                            <h4 class="font-semibold">${liftName}</h4>
                            <p class="text-sm text-[var(--text-secondary)]">
                                Current Est. 1RM: ${data[data.length - 1]['1rm'].toFixed(1)}kg
                            </p>
                            <svg viewBox="0 0 100 100" class="w-full h-20" preserveAspectRatio="none">
                                <polyline fill="none" stroke="var(--accent-blue)" stroke-width="2" points="${points}" />
                            </svg>
                        </div>
                    `;
                }).join('');
            },
            
            // --- Coach Page (Gemini) ---
            renderCoachPage() {
                app.innerHTML = `
                    <div class="p-4 max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-4">Alfie's Coach ✨</h1>
                        <p class="text-[var(--text-secondary)] mb-6">Ask any fitness or nutrition questions. Your coach is powered by Gemini.</p>
                        
                        <!-- API Key Input -->
                        <div class="mb-6">
                            <label class="block text-sm text-[var(--text-secondary)] mb-1">Your Google AI Studio API Key</label>
                            <input id="gemini-api-key" type="password" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" value="${this.geminiApiKey}">
                            <button class="w-full bg-[var(--accent-blue)] text-white p-2 rounded-lg mt-2 font-semibold" onclick="appState.saveGeminiKey()">
                                Save Key
                            </button>
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-[var(--accent-blue)] hover:underline mt-1 block">Get an API Key from AI Studio</a>
                        </div>
                        
                        <!-- Chat -->
                        <div class="bg-[var(--bg-secondary)] p-4 rounded-lg shadow-lg">
                            <textarea id="coach-prompt" class="w-full bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)]" rows="4" placeholder="e.g., What's a good post-workout snack?"></textarea>
                            <button class="w-full bg-[var(--accent-blue)] text-white p-3 rounded-lg mt-4 font-semibold" onclick="appState.askTheCoach()">
                                Ask Question
                            </button>
                        </div>
                    </div>
                `;
            },
            
            saveGeminiKey() {
                const key = document.getElementById('gemini-api-key').value;
                this.geminiApiKey = key;
                this.saveState();
                alert('API Key saved!');
            },
            
            askTheCoach() {
                const prompt = document.getElementById('coach-prompt').value;
                if (!prompt) {
                    alert('Please enter a question.');
                    return;
                }
                
                const systemPrompt = "You are Alfie's Coach, a friendly, motivational, and knowledgeable personal trainer. Alfie is a beginner just starting his fitness journey. Keep your answers concise, encouraging, and easy to understand. Focus on safety and consistency. Always answer in the 2nd person (use 'you' and 'your').";
                
                this.callGeminiApi(prompt, systemPrompt, (response) => {
                    this.showModal("Alfie's Coach Says...", response);
                });
            },
            
            getFormTips(exerciseName) {
                const prompt = `Give me simple, step-by-step form tips for a beginner doing ${exerciseName}. Focus on the 3 most important cues.`;
                const systemPrompt = "You are a concise personal trainer. Provide bullet points. Be clear and focus on safety for a beginner.";
                
                this.callGeminiApi(prompt, systemPrompt, (response) => {
                    this.showModal(`Form Tips: ${exerciseName}`, response);
                });
            },
            
            // --- Gemini API Call ---
            callGeminiApi(userPrompt, systemPrompt, onSuccess) {
                if (!this.geminiApiKey) {
                    this.showModal("API Key Missing", "Please add your Google AI Studio API Key on the 'Coach' page to use this feature.", true);
                    return;
                }
                
                this.showModal("Thinking...", "Getting a response from your AI coach...", false);
                this.geminiApiCallCount = 0; // Reset retry count
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.geminiApiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                const fetchWithRetry = () => {
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(result => {
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            const text = candidate.content.parts[0].text;
                            onSuccess(text);
                        } else {
                            throw new Error(result.error?.message || "Invalid AI response");
                        }
                    })
                    .catch(err => {
                        this.geminiApiCallCount++;
                        if (this.geminiApiCallCount < this.geminiMaxRetries) {
                            setTimeout(fetchWithRetry, 1000 * this.geminiApiCallCount); // Exponential backoff
                        } else {
                            this.showModal("Uh oh!", `Failed to get response from AI after ${this.geminiMaxRetries} attempts.\n\n${err.message}`, true);
                        }
                    });
                };
                
                fetchWithRetry();
            },
            
            // --- Modal ---
            showModal(title, content, showClose = true) {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-content').innerText = content;
                document.getElementById('modal-footer').style.display = showClose ? 'flex' : 'none';
                document.getElementById('generic-modal').classList.remove('hidden');
            },
            
            hideModal() {
                document.getElementById('generic-modal').classList.add('hidden');
            },

            // --- Workout In Progress ---
            startNextWorkout() {
                const next = this.getNextWorkout();
                this.startWorkout(next.week, next.dayKey, next.program);
            },
            
            startSpecificWorkout(weekNum, dayKey) {
                if (this.activeWorkout) return;
                
                let week = parseInt(weekNum);
                let program;

                if (week >= 1 && week <= 4) program = this.workoutProgram.weeks1_4;
                else if (week >= 5 && week <= 8) program = this.workoutProgram.weeks5_8;
                else program = this.workoutProgram.weeks9_12;

                this.startWorkout(week, dayKey, program);
            },
            
            startWorkout(week, dayKey, program) {
                const day = program[dayKey];
                this.activeWorkout = {
                    week: week,
                    dayKey: dayKey,
                    day: day,
                    exercises: day.exercises.map(ex => ({
                        ...ex,
                        sets: Array.from({ length: ex.sets }, () => ({ weight: null, reps: null }))
                    })),
                    date: new Date().toISOString()
                };
                
                this.saveState();
                this.navigateTo('workout');
            },
            
            resumeWorkout() {
                this.navigateTo('workout');
            },
            
            cancelWorkout() {
                // Use a confirmation modal
                this.showModal(
                    "Cancel Workout?", 
                    "Are you sure? All progress for this session will be lost.", 
                    false // Hide default close button
                );
                
                // Add custom buttons
                const footer = document.getElementById('modal-footer');
                footer.style.display = 'flex';
                footer.innerHTML = `
                    <button onclick="appState.hideModal()" class="bg-[var(--bg-secondary-light)] text-white px-4 py-2 rounded-lg mr-2">Go Back</button>
                    <button onclick="appState.confirmCancelWorkout()" class="bg-red-600 text-white px-4 py-2 rounded-lg">Cancel Workout</button>
                `;
            },
            
            confirmCancelWorkout() {
                this.activeWorkout = null;
                this.saveState();
                this.hideModal();
                this.navigateTo('home');
            },
            
            finishWorkout() {
                this.history.push(this.activeWorkout);
                this.activeWorkout = null;
                this.saveState();
                this.navigateTo('home');
            },

            renderWorkoutInProgressPage() {
                if (!this.activeWorkout) {
                    this.navigateTo('home');
                    return;
                }
                
                const workout = this.activeWorkout;

                app.innerHTML = `
                    <div class="p-4 max-w-3xl mx-auto">
                        <h1 class="text-3xl font-bold mb-1">${workout.day.name}</h1>
                        <p class="text-lg text-[var(--text-secondary)] mb-6">Week ${workout.week}</p>
                        
                        <div id="exercise-list">
                            ${workout.exercises.map((ex, exIndex) => {
                                // Find the original target sets
                                let originalEx = ex;
                                try {
                                    let weekKey;
                                    if (workout.week <= 4) weekKey = 'weeks1_4';
                                    else if (workout.week <= 8) weekKey = 'weeks5_8';
                                    else weekKey = 'weeks9_12';
                                    originalEx = this.workoutProgram[weekKey][workout.dayKey].exercises.find(e => e.name === ex.name) || ex;
                                } catch (e) {}
                                
                                const originalTargetSets = originalEx.sets;
                                const completedSets = ex.sets.filter(s => s.weight !== null && s.reps !== null).length;
                                
                                const isComplete = completedSets >= originalTargetSets;
                                const cardBg = isComplete ? 'bg-[var(--accent-green-dark)]' : 'bg-[var(--bg-secondary)]';
                                
                                const max1rm = ex.sets.reduce((max, set) => {
                                    const current1rm = this.calculate1RME(set.weight, set.reps);
                                    return current1rm > max ? current1rm : max;
                                }, 0);

                                return `
                                    <div class="mb-4 p-4 rounded-lg shadow-lg ${cardBg}" id="exercise-card-${exIndex}">
                                        <div class="flex justify-between items-center mb-3">
                                            <h3 class="text-xl font-semibold">${ex.name}</h3>
                                            <button class="text-[var(--accent-blue)]" onclick="appState.getFormTips('${ex.name}')">
                                                ${this.icons.sparkle}
                                            </button>
                                        </div>
                                        <div class="flex justify-between items-start mb-4">
                                            <p class="text-sm text-[var(--text-secondary)]">Target: ${originalTargetSets} sets x ${ex.reps}</p>
                                            
                                            <div class="text-right bg-[var(--bg-primary)] px-3 py-1 rounded-md">
                                                <span class="text-xs text-[var(--text-secondary)]">Est. 1RM</span>
                                                <p class="font-bold text-lg" id="1rm-${exIndex}">${max1rm > 0 ? max1rm.toFixed(1) + 'kg' : '-'}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Sets Header -->
                                        <div class="flex items-center text-sm text-[var(--text-secondary)] mb-2 px-2">
                                            <span class="w-1/4 font-semibold">Set</span>
                                            <span class="w-1/4 font-semibold">Weight (kg)</span>
                                            <span class="w-1/4 font-semibold">Reps</span>
                                            <span class="w-1/4 font-semibold"></span>
                                        </div>
                                        
                                        <!-- Sets List -->
                                        <div id="set-list-${exIndex}">
                                            ${ex.sets.map((set, setIndex) => this.renderSetInput(exIndex, setIndex, set)).join('')}
                                        </div>
                                        
                                        <!-- Add Set Button -->
                                        <button class="w-full bg-[var(--bg-secondary-light)] text-white p-2 rounded-lg mt-4 font-semibold" onclick="appState.addSet(${exIndex})">
                                            + Add Set
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <!-- Finish/Cancel Buttons -->
                        <div class="mt-8">
                            <button class="w-full bg-[var(--accent-blue)] text-white p-3 rounded-lg font-semibold" onclick="appState.finishWorkout()">
                                Finish Workout
                            </button>
                            <button class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold mt-4" onclick="appState.cancelWorkout()">
                                Cancel Workout
                            </button>
                        </div>
                    </div>
                `;
            },
            
            renderSetInput(exIndex, setIndex, set) {
                return `
                    <div class="flex items-center space-x-2 mb-2 p-2 rounded" id="set-${exIndex}-${setIndex}">
                        <span class="w-1/4 font-semibold text-lg text-center">${setIndex + 1}</span>
                        <input 
                            type="number" 
                            step="0.5" 
                            class="w-1/4 bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)] text-center" 
                            placeholder="kg"
                            value="${set.weight || ''}"
                            autocomplete="off"
                            oninput="appState.updateSet(${exIndex}, ${setIndex}, 'weight', this.value)"
                        >
                        <input 
                            type="number" 
                            step="1" 
                            class="w-1/4 bg-[var(--bg-primary)] p-2 rounded border border-[var(--bg-secondary-light)] text-center" 
                            placeholder="reps"
                            value="${set.reps || ''}"
                            autocomplete="off"
                            oninput="appState.updateSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                        >
                        <span class="w-1/4 text-center">
                            <!-- Placeholder for checkmark -->
                        </span>
                    </div>
                `;
            },
            
            updateSet(exIndex, setIndex, field, value) {
                const numValue = value === '' ? null : parseFloat(value);
                this.activeWorkout.exercises[exIndex].sets[setIndex][field] = numValue;
                
                // Don't save state on every keypress, too slow.
                // Just update UI.
                
                // Recalculate 1RM
                const sets = this.activeWorkout.exercises[exIndex].sets;
                const max1rm = sets.reduce((max, set) => {
                    const current1rm = this.calculate1RME(set.weight, set.reps);
                    return current1rm > max ? current1rm : max;
                }, 0);
                
                document.getElementById(`1rm-${exIndex}`).innerText = max1rm > 0 ? max1rm.toFixed(1) + 'kg' : '-';
                
                // Check for completion
                // Find original target sets
                let originalEx = this.activeWorkout.exercises[exIndex];
                try {
                    const workout = this.activeWorkout;
                    let weekKey;
                    if (workout.week <= 4) weekKey = 'weeks1_4';
                    else if (workout.week <= 8) weekKey = 'weeks5_8';
                    else weekKey = 'weeks9_12';
                    originalEx = this.workoutProgram[weekKey][workout.dayKey].exercises.find(e => e.name === originalEx.name) || originalEx;
                } catch(e) {}
                
                const targetSets = originalEx.sets;
                const completedSets = this.activeWorkout.exercises[exIndex].sets.filter(s => s.weight !== null && s.reps !== null).length;
                const card = document.getElementById(`exercise-card-${exIndex}`);
                
                if (completedSets >= targetSets) {
                    card.classList.add('bg-[var(--accent-green-dark)]');
                    card.classList.remove('bg-[var(--bg-secondary)]');
                } else {
                    card.classList.add('bg-[var(--bg-secondary)]');
                    card.classList.remove('bg-[var(--accent-green-dark)]');
                }
                
                // Save state after UI update
                this.saveState();
            },
            
            addSet(exIndex) {
                this.activeWorkout.exercises[exIndex].sets.push({ weight: null, reps: null });
                this.saveState();
                
                const setIndex = this.activeWorkout.exercises[exIndex].sets.length - 1;
                const set = this.activeWorkout.exercises[exIndex].sets[setIndex];
                
                const setListEl = document.getElementById(`set-list-${exIndex}`);
                const newSetHtml = this.renderSetInput(exIndex, setIndex, set);
                setListEl.insertAdjacentHTML('beforeend', newSetHtml);
            },
            
            // --- Utilities ---
            calculate1RME(weight, reps) {
                if (!weight || !reps || reps < 1) return 0;
                // Epley formula
                return weight * (1 + reps / 30);
            },

            // --- Timer Logic ---
            timer: {
                minutes: 2,
                seconds: 0,
                interval: null,
                modalOpen: false,
                audioContext: null,

                initAudio() {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                },

                beep(hz, duration, type = "sine") {
                    if (!this.audioContext) this.initAudio();
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.type = type;
                    oscillator.frequency.setValueAtTime(hz, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + duration / 1000);
                },

                speak(text) {
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.rate = 1.0;
                        window.speechSynthesis.speak(utterance);
                    }
                },

                updateDisplay() {
                    const display = document.getElementById('timer-display');
                    if (display) {
                        display.innerText = `${this.minutes}:${this.seconds.toString().padStart(2, '0')}`;
                    }
                },

                set(totalSeconds) {
                    if (this.interval) this.reset();
                    this.minutes = Math.floor(totalSeconds / 60);
                    this.seconds = totalSeconds % 60;
                    this.updateDisplay();
                },

                startPause() {
                    const btn = document.getElementById('timer-start-pause');
                    if (this.interval) {
                        // Pause
                        clearInterval(this.interval);
                        this.interval = null;
                        btn.innerText = 'Start';
                    } else {
                        // Start
                        this.initAudio(); // Initialize audio on user interaction
                        btn.innerText = 'Pause';
                        this.interval = setInterval(() => this.tick(), 1000);
                    }
                },

                reset() {
                    clearInterval(this.interval);
                    this.interval = null;
                    this.set(120); // Default to 2:00
                    document.getElementById('timer-start-pause').innerText = 'Start';
                    document.getElementById('countdown-modal').classList.add('hidden');
                },

                tick() {
                    if (this.seconds > 0) {
                        this.seconds--;
                    } else if (this.minutes > 0) {
                        this.minutes--;
                        this.seconds = 59;
                    } else {
                        // Timer finished
                        clearInterval(this.interval);
                        this.interval = null;
                        this.onFinish();
                        return;
                    }

                    this.updateDisplay();
                    this.checkCountdown();
                },

                checkCountdown() {
                    const countdownModal = document.getElementById('countdown-modal');
                    const countdownDisplay = document.getElementById('countdown-display');
                    
                    if (this.minutes === 0) {
                        if (this.seconds === 3) {
                            countdownDisplay.innerText = '3';
                            countdownModal.classList.remove('hidden');
                            this.beep(800, 100);
                        } else if (this.seconds === 2) {
                            countdownDisplay.innerText = '2';
                            this.beep(800, 100);
                        } else if (this.seconds === 1) {
                            countdownDisplay.innerText = '1';
                            this.beep(800, 100);
                        }
                    }
                },

                onFinish() {
                    document.getElementById('countdown-modal').classList.add('hidden');
                    this.beep(1200, 150); // Final beep
                    this.speak("Your rest is up - Get after it Alfie");
                    this.reset();
                }
            },
            
            toggleTimerModal(open) {
                this.timer.modalOpen = open;
                document.getElementById('timer-modal').classList.toggle('hidden', !open);
                this.renderApp(); // Re-render to hide/show floating button
            },

            // --- Icons (as SVGs) ---
            icons: {
                home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`,
                dumbbell: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 10h2v8H6zM16 10h2v8h-2zM12 2a4 4 0 0 0-4 4v2H4v8h4v-2a4 4 0 0 0 4-4h0a4 4 0 0 0 4 4v2h4v-8h-4V6a4 4 0 0 0-4-4zM8 18v2h8v-2z"/></svg>`,
                progress: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`,
                coach: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-7.52 16.96l-1.31 1.63a.5.5 0 0 0 .62.78l1.88-1.4A10 10 0 1 0 12 2Z"></path><path d="M8 12h.01"></path><path d="M12 12h.01"></path><path d="M16 12h.01"></path></svg>`,
                play: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`,
                "delete": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
                sparkle: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l.94 2.06L15 5l-2.06.94L12 8l-.94-2.06L9 5l2.06.94L12 2zM5 12l.94 2.06L8 15l-2.06.94L5 18l-.94-2.06L2 15l2.06.94L5 12zM19 12l.94 2.06L22 15l-2.06.94L19 18l-.94-2.06L16 15l2.06.94L19 12z"/></svg>`
            },

            // --- Initializer ---
            init() {
                console.log("Alfie's App: Initializing...");
                this.loadState();
                this.renderApp();
            }
        };

        // --- Start The App ---
        document.addEventListener('DOMContentLoaded', () => {
            appState.init();
        });

    </script>
</body>
</html>

